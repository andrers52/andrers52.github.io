"use strict";import EObject from"../../libs/arslib/enhancements/e-object.js";import Vector,{vect}from"../../common/geometry/Vector.js";import eventFakeSocket from"../../common/singleton/eventFakeSocket.js";import BECommonDefinitions from"../../common/BECommonDefinitions.js";import environment from"../agent/singleton/Environment.js";import BEServer from"../../server/singleton/BEServer.js";import Camera from"../../server/agent/Camera.js";import FollowsAgent from"../../server/agent/mixin/behavior_component/FollowsAgent.js";import User from"../User.js";var idToUsers={};function ConnectorConstructor(){var e;this.getUserIds=function(){return Object.keys(idToUsers)},this.getUsers=function(){return Object.values(idToUsers)},this.getUserById=function(e){return idToUsers[e]},this.playSoundInClient=function(e){for(var n in idToUsers){idToUsers[n].socket.emit("Sound.playSound",e)}},this.playProceduralSoundInClient=function(e,n){if(BECommonDefinitions.config.playProceduralSoundInClient)for(var t in idToUsers){let o=idToUsers[t];o.agent&&o.camera.rectangle.checkPointInside(n)&&o.socket.emit("playDescr",e)}},this.playSoundInClientLoop=function(e){for(var n in idToUsers){idToUsers[n].socket.emit("Sound.playSoundLoop",e)}},this.setVisibleAgents=function(){for(var e in idToUsers){let n=idToUsers[e];if(!n.camera)continue;let t=environment.getNearbyAgentsByRectangle(n.camera.rectangle).filter(e=>!e.isCamera&&n.camera.canBeSeen(e.rectangle));n.socket.emit("update",t)}},this.setCamera=function(e){BECommonDefinitions.config.userAlwaysAtCenterOfCamera&&idToUsers[e.owner.id]&&idToUsers[e.owner.id].socket.emit("camera",e)},this.messageToGameClient=function(n,t){0!==Object.keys(idToUsers).length&&e.emit("messageToGameClient",{message:n,contentObject:t})},this.messageToSingleGameClient=function(e,n,t){if(idToUsers[e])try{idToUsers[e].socket.emit("messageToGameClient",{message:n,contentObject:t})}catch(e){console.log(`data encoding error. Message is:${n},  contentObject is: ${JSON.stringify(t)}`)}},this.removeUserByOwningAgentId=function(e){for(var n in idToUsers){let t=idToUsers[n];t.agent&&t.agent.id===e&&(BEServer.currentApp.onUserDead(t),delete idToUsers[n])}},this.start=function(n){if(n)e=eventFakeSocket;else{const n=require("cors");var t=require("express"),o=t();const i={origin:`http://${BECommonDefinitions.WEB_SOCKET_ADDRESS_IP}`};o.use(n(i));var r=require("http").Server(o);e=require("socket.io")(r),r.listen(BECommonDefinitions.WEB_PORT,function(){console.log("Web server listening at port %d",BECommonDefinitions.WEB_PORT)}),o.use(t.static("."))}e.on("connection",function(e){n&&(e=eventFakeSocket);let t=e,o=new User(e);t.on("LOG_MESSAGE",function(e){console.log(e)}),t.on("disconnect",function(){BEServer.currentApp.onUserDead(o),delete idToUsers[o.id]}),t.on("BEServer.clientStart",function(e){o.name=e.userName;let n=e.cameraSize;EObject.extend(n,Vector.prototype),console.log("EXEC: BEServer.clientStart"),BECommonDefinitions.config.worldToCameraSize&&(BECommonDefinitions.WORLD_WIDTH=n.x,BECommonDefinitions.WORLD_HEIGHT=n.y),BEServer.currentApp.onUserConnected(o,n),idToUsers[o.id]=o,o.camera=new Camera(o),BEServer.config.cameraFollowUser?(o.camera.start(n,o.agent.getPosition()),FollowsAgent.call(o.camera,o.agent,!0)):o.camera.start(n,vect(0,0)),t.emit("BEServer.clientStartReady",{userAgentId:o.agent?o.agent.id:0,backgroundImagename:BEServer.getBackgroundImageName()}),BEServer.currentApp.sendInitialData&&BEServer.currentApp.sendInitialData(o),t.on("userEvent",function(e){BEServer.propagateUserEvent(e.event,e.arg,o.agent)})}),t.on("requestInitialPageInfo",()=>{t.emit("requestInitialPageInfoReady",{highScores:BEServer.currentApp.getHighScores()})})})}}var connector=new ConnectorConstructor;export default connector;