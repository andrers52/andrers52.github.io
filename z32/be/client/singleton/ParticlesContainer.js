"use strict";import Assert from"../../../libs/arslib/util/assert.js";import EFunction from"../../../libs/arslib/enhancements/e-function.js";import Random from"../../../libs/arslib/util/random.js";import Util from"../../../libs/arslib/util/util.js";import{vect}from"../../common/geometry/Vector.js";import resourceStore from"./ResourceStore.js";import coordinatesConversion from"./CoordinatesConversion.js";import screen from"./Screen.js";function ParticlesContainer(){let e,t,i,r;function o(e,i){let r=e.screenParticle?vect(e.positionX,e.positionY):coordinatesConversion.worldToCanvas(vect(e.positionX,e.positionY));for(let o in t)i.globalAlpha=e.color[o]/255*e.opacity,0!==i.globalAlpha&&i.drawImage(t[o],r.x-e.radius/screen.zoomOutFactor,r.y-e.radius/screen.zoomOutFactor,2*e.radius/screen.zoomOutFactor,2*e.radius/screen.zoomOutFactor)}this.DEFAULT_RADIUS=10,this.CIRCULAR_EMITTER_DEFAULT_RADIUS=5*this.DEFAULT_RADIUS,this.DEFAULT_PARTICLE_TIME_TO_LIVE=1e3,this.DEFAULT_EMITTER_TIME_TO_LIVE=1e3,this.DEFAULT_PARTICLE_RELEASE_LATENCY=100,this.start=function(){i={},r=[],e=resourceStore.retrieveResourceObject("whiteParticle.jpg"),t={red:resourceStore.retrieveResourceObject("redParticle.jpg"),green:resourceStore.retrieveResourceObject("greenParticle.jpg"),blue:resourceStore.retrieveResourceObject("blueParticle.jpg")}},this.createParticle=function({positionX:e,positionY:t,speedX:r,speedY:o,screenParticle:s,colorRed:n,colorGreen:a,colorBlue:c,timeToLive:l,radius:m,occurrenceProbability:u}){if(n="number"==typeof n?n:255,a="number"==typeof a?a:255,c="number"==typeof c?c:255,l=l||this.DEFAULT_PARTICLE_TIME_TO_LIVE,m=m||this.DEFAULT_RADIUS,u="number"==typeof u?u:1,!Random.occurrenceProbability(u))return;Assert.assertValueIsInsideLimits(n,0,255),Assert.assertValueIsInsideLimits(a,0,255),Assert.assertValueIsInsideLimits(c,0,255);let T=vect(r,o);for(let r=0;r<u;r++){let r={positionX:e,positionY:t,speedX:T.x,speedY:T.y,screenParticle:s,color:{red:n,green:a,blue:c},radius:m,timeToLive:l,creationTime:Util.currentTime(),opacity:1};i[Random.randomInt(1e7)]=r}},this.createParticleInSpray=function(e,t,i,r,o=!0,s=255,n=255,a=255,c=this.DEFAULT_PARTICLE_TIME_TO_LIVE,l=this.DEFAULT_RADIUS,m=1,u=1,T=this.DEFAULT_PARTICLE_TIME_TO_LIVE/20,d=2){i+=Random.randomFromInterval(-u,u),r+=Random.randomFromInterval(-u,u),c+=Random.randomFromInterval(-T,T),s+=Random.randomFromInterval(-d,d),s=Util.limitValueToMinMax(s,0,255),n+=Random.randomFromInterval(-d,d),n=Util.limitValueToMinMax(n,0,255),a+=Random.randomFromInterval(-d,d),a=Util.limitValueToMinMax(a,0,255),this.createParticle({positionX:e,positionY:t,speedX:i,speedY:r,screenParticle:o,colorRed:s,colorGreen:n,colorBlue:a,timeToLive:c,radius:l,occurrenceProbability:m})},this.createCircularEmitter=function(e,t,i,o,s=!0,n,a=255,c=255,l=255,m=this.DEFAULT_PARTICLE_RELEASE_LATENCY,u=this.DEFAULT_EMITTER_TIME_TO_LIVE,T=this.CIRCULAR_EMITTER_DEFAULT_RADIUS){if(Assert.assertValueIsInsideLimits(a,0,255),Assert.assertValueIsInsideLimits(c,0,255),Assert.assertValueIsInsideLimits(l,0,255),n){let e=r.find(e=>e.ownerAgentId===n);if(e)return void(e.creationTime=Util.currentTime())}let d={positionX:e,positionY:t,speedX:i,speedY:o,ownerAgentId:n,screenEmitter:s,color:{red:a,green:c,blue:l},radius:T,timeToLive:u,creationTime:Util.currentTime()},p=Random.randomFromInterval(0,2*Math.PI);d.run=EFunction.limitCallingRateWithDiscard(()=>{particlesContainer.createParticle({positionX:e+Math.cos(p)*T,positionY:t+Math.sin(p)*T,speedX:0,speedY:0,screenParticle:s,colorRed:a,colorGreen:c,colorBlue:l,timeToLive:u,radius:T/5,occurrenceProbability:1}),p+=.5},m),r.push(d)},this.createSprayEmitter=function(e,t,i,o,s=!0,n=255,a=255,c=255,l=this.DEFAULT_PARTICLE_RELEASE_LATENCY,m=this.DEFAULT_EMITTER_TIME_TO_LIVE,u=this.CIRCULAR_EMITTER_DEFAULT_RADIUS){Assert.assertValueIsInsideLimits(n,0,255),Assert.assertValueIsInsideLimits(a,0,255),Assert.assertValueIsInsideLimits(c,0,255);let T={positionX:e,positionY:t,speedX:i,speedY:o,screenEmitter:s,color:{red:n,green:a,blue:c},radius:u,timeToLive:m,creationTime:Util.currentTime()};T.run=EFunction.limitCallingRateWithDiscard(()=>{particlesContainer.createParticleInSpray(e,t,i,o,s)},l),r.push(T)},this.animationStep=function(){0===i.length&&0===r.length||(r.forEach(function(e){e.run(),e.positionX+=e.speedX,e.positionY-=e.speedY}),r=r.filter(e=>!e.timeToLive||Util.currentTime()-e.creationTime<e.timeToLive),function(){for(let e in i){let t=i[e];t.positionX+=t.speedX,t.positionY-=t.speedY;let r=Util.currentTime()-t.creationTime,o=t.timeToLive-r;t.timeToLive<=r?delete i[e]:t.opacity=o/t.timeToLive}}(),function(){let e=screen.getContext();for(let t in i){let r=i[t];e.save(),e.globalCompositeOperation="lighter",o(r,e),e.restore()}}())}}let particlesContainer=new ParticlesContainer;export default particlesContainer;