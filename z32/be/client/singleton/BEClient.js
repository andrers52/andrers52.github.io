"use strict";import Assert from"../../../libs/arslib/util/assert.js";import EObject from"../../../libs/arslib/enhancements/e-object.js";import Vector from"../../common/geometry/Vector.js";import eventFakeSocket from"../../common/singleton/eventFakeSocket.js";import Rectangle,{rect}from"../../common/geometry/Rectangle.js";import BECommonDefinitions from"../../common/BECommonDefinitions.js";import BEClientDefinitions from"../BEClientDefinitions.js";import resourceStore from"./ResourceStore.js";import screen from"./Screen.js";import Sound from"../../../libs/arslib/util/Sound.js";import userEvents from"./UserEvents.js";import coordinatesConversion from"./CoordinatesConversion.js";import BrowserUtil from"../BrowserUtil.js";let BEClient={};function setCameraToAgentPosition(e){let n=screen.getSize().multiplyByScalar(screen.zoomOutFactor);setCamera({rectangle:{center:{x:e.rectangle.center.x,y:e.rectangle.center.y},size:{x:n.x,y:n.y}}})}BEClient.userName="",BEClient.onAfterDrawAgent=null,BEClient.onBeforeDrawAgent=null,BEClient.onAfterDrawScreen=null,BEClient.app=null,BEClient.agentsExecutionIntervalId=null,BEClient.visibleAgents=[],BEClient.getVisibleAgents=function(){return BEClient.visibleAgents},BEClient.getVisibleAgentByProperty=function(e,n){return BEClient.visibleAgents.find(t=>t[e]===n)},BEClient.setVisibleAgents=function(e){if(BEClient.visibleAgents=e,BEClient.config.userAlwaysAtCenterOfCamera){setCameraToAgentPosition(BEClient.visibleAgents.find(e=>!!e.name&&e.name===BEClient.userName))}};let camera={rectangle:rect(0,0,1,1)};function setCamera(e){Object.assign(camera,e),EObject.extend(camera.rectangle,Rectangle.prototype),EObject.extend(camera.rectangle.center,Vector.prototype),EObject.extend(camera.rectangle.size,Vector.prototype)}function removeAllAudioEvents(){resourceStore.retrieveAllAudioNames().map(e=>Sound.clearAllEvents(e))}function removeLoadingMessage(){let e=document.getElementById("loading");e&&e.parentNode.removeChild(e)}function propagateUserEvent(e,n){let t={event:e,arg:n};BEClient.socket.emit("userEvent",t),e.includes("Mouse")||window.dispatchEvent(new CustomEvent(e,{detail:n,bubbles:!1,composed:!0}))}function _startConnection(){BEClient.config.localApp?(BEClient.socket=eventFakeSocket,BEClient.socket.emit("connection",{},()=>{})):BEClient.socket=io(BECommonDefinitions.WEB_SOCKET_ADDRESS),BEClient.socket.on("update",function(e){BEClient.setVisibleAgents(e)}),BEClient.socket.on("Sound.playSound",function(e){Sound.playSound(e)}),BEClient.socket.on("playDescr",function(e){new SoundEffect(BEClient.app.getSoundEffectDescription(e)).generate().getAudio().play()}),BEClient.socket.on("Sound.playSoundLoop",function(e){Sound.playSoundLoop(e)}),BEClient.socket.on("camera",function(e){setCamera(e)}),BEClient.socket.on("messageToGameClient",function(e){BEClient.app[e.message]||console.log("Server message not understood: "+e.message),BEClient.app[e.message](e.contentObject)}),BEClient.socket.on("BEClient.openModalLink",function(){document.getElementById("openModalLink").click()}),BEClient.socket.on("BEClient.localization.setCurrentLanguage",function(e){console.log(`${e}: Not using localization for now...`)}),BEClient.socket.on("disconnect",function(){userEvents.stop(),location.reload()})}function loadCommonResources(){resourceStore.createEffectsFromDescriptor(BECommonDefinitions.COMMON_EFFECTS_DESCRIPTION),BECommonDefinitions.COMMON_RESOURCES.forEach(e=>resourceStore.addResource(e))}BEClient.getCamera=function(){return camera},BEClient.start=function(e){BEClient.app=e;loadCommonResources(),BEClient.app.getEffectsDescription&&resourceStore.createEffectsFromDescriptor(BEClient.app.getEffectsDescription()),resourceStore.callWhenReady(()=>{removeLoadingMessage(),BEClient.config=resourceStore.retrieveResourceObject(BECommonDefinitions.CONFIG_JSON),_startConnection(),BECommonDefinitions.start(BEClient.config),"deploy"===BECommonDefinitions.config.buildType&&(Assert.disableAllVerifications=!0),BEClient.connectToGameServer()})},BEClient.connectToGameServer=function(){BEClient.visibleAgents=[],screen.stopGamePresentationLoop(),removeAllAudioEvents(),resourceStore.removeTemporaryResources();Assert.assertIsFunction(BEClient.app.getMediaAssets,"You need to define 'getMediaAssets' on the game to be able to load your media assets."),BEClient.app.getMediaAssets().forEach(e=>resourceStore.addResource(e)),resourceStore.callWhenReady(async()=>{BEClient.app.onAfterDrawAgent&&(BEClient.onAfterDrawAgent=BEClient.app.onAfterDrawAgent.bind(BEClient.app)),BEClient.app.onBeforeDrawAgent&&(BEClient.onBeforeDrawAgent=BEClient.app.onBeforeDrawAgent.bind(BEClient.app)),BEClient.app.onAfterDrawScreen&&(BEClient.onAfterDrawScreen=BEClient.app.onAfterDrawScreen.bind(BEClient.app)),screen.start({onBeforeDrawAgentInput:BEClient.onBeforeDrawAgent,onAfterDrawAgentInput:BEClient.onAfterDrawAgent,onAfterDrawScreenInput:BEClient.onAfterDrawScreen,minScreenDimensionInput:BECommonDefinitions.MIN_SCREEN_DIMENSION,getVisibleAgentsInput:BEClient.getVisibleAgents,cameraInput:camera,canvasIdInput:BEClientDefinitions.CANVAS_ID,worldWidth:BECommonDefinitions.WORLD_WIDTH,worldHeight:BECommonDefinitions.WORLD_HEIGHT}),BEClient.config.worldToCameraSize&&screen.setWorldToCameraSize(),BEClient.userName="user",BEClient.app.showInitialScreenAndReturnUserName&&(BEClient.userName=await BEClient.app.showInitialScreenAndReturnUserName());let e={userName:BEClient.userName,cameraSize:camera.rectangle.size};BEClient.socket.on("BEServer.clientStartReady",function(e){let n=e.userAgentId;BEClient.setBackgroundImageName(e.backgroundImagename),BEClient.app.onConnectToServer&&BEClient.app.onConnectToServer(BEClient.userName,n),userEvents.start(BEClientDefinitions.MOUSE_MOVE_PROPAGATION_LATENCY,propagateUserEvent),coordinatesConversion.start(camera),screen.gamePresentationLoop()}),BEClient.socket.emit("BEServer.clientStart",e)})},BEClient.setBackgroundImageName=function(e){screen.setBackgroundImageName(e)};export{BEClient as default};