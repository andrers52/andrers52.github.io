"use strict";import Assert from"../../../libs/arslib/util/assert.js";import EFunction from"../../../libs/arslib/enhancements/e-function.js";import{createAgent}from"../../../be/server/agent/Agent.js";import createLaser from"./weapons/laser/Laser.js";import createMissile from"./weapons/missile/Missile.js";import createMine from"./weapons/mine/Mine.js";import Vector,{vect}from"../../../be/common/geometry/Vector.js";import connector from"../../../be/server/singleton/Connector.js";import Turnable from"../../../be/server/agent/mixin/Turnable.js";import HasBehavior from"../../../be/server/agent/mixin/HasBehavior.js";import HasEnergy from"../../../be/server/agent/mixin/HasEnergy.js";import GameCommonDefinitions from"../../common/GameCommonDefinitions.js";import GameServerZ32Definitions from"../GameServerZ32Definitions.js";import createShipSplash from"./ShipSplash.js";export default function createShip(e,n,r,t){let i=GameServerZ32Definitions,o=createAgent(e.name.toUpperCase().includes("LOL")?GameCommonDefinitions.LOL_IMAGE:e.name.toUpperCase().includes("TRUMP")?GameCommonDefinitions.TRUMP_IMAGE:GameCommonDefinitions.USER_SHIP_IMAGE,i.SHIP_WIDTH,i.SHIP_HEIGHT,!0,r,t);if(!o)return null;Turnable.call(o,1),o.speed=new Vector,o.userId=e.id,o.name=e.name,o.userScore=0;let a=0;o.thrust=0,o.currentWeapon="laser",o.alternateWeaponTimeLeft=0,o.createLaser=EFunction.limitCallingRateWithDiscard(createLaser,i.LASER_FIRING_LATENCY),o.createMissile=EFunction.limitCallingRateWithDiscard(createMissile,i.MISSILE_FIRING_LATENCY),o.createMine=EFunction.limitCallingRateWithDiscard(createMine,i.MINE_FIRING_LATENCY),o.die=EFunction.sequence(function(){createShipSplash(o),connector.playProceduralSoundInClient("SHIP_DIE_AUDIO_OBJECT_DESCRIPTION",o.getPosition()),connector.messageToSingleGameClient(o.userId,"userIsDead"),connector.removeUserByOwningAgentId(this.id)},o.die,o),o.onHittingWorldBorder=function(){o.die()},HasBehavior.call(o,function(){return"laser"!==o.currentWeapon&&(--o.alternateWeaponTimeLeft,0===o.alternateWeaponTimeLeft&&(o.currentWeapon="laser")),function(){let e=Vector.makeFromAngleAndSize(o.orientation,i.SHIP_THRUST),n=i.SHIP_THRUST*i.SHIP_THRUST_TO_ENERGY_FACTOR;o.decreaseEnergy(n)&&(o.thrust=i.SHIP_THRUST,o.speed.addWithLimits(e,i.SHIP_MAX_SPEED,-i.SHIP_MAX_SPEED,!1))}(),function(){if(o.speed.size()<c)return void(o.speed=vect());let e=o.speed.clone().multiplyByScalar(-s);o.speed.add(e)}(),Assert.assertIsNumber(o.speed.x),Assert.assertIsNumber(o.speed.y),o.move(o.speed),function(){if(Math.abs(a-o.orientation)<i.SHIP_TURN_ANGLE)return;let e=Math.abs(a-o.orientation)>Math.PI;o.decreaseEnergy(i.SHIP_TURN_ANGLE_ENERGY_COST)&&(a>o.orientation?e?o.rotateClockwise(i.SHIP_TURN_ANGLE):o.rotateCounterclockwise(i.SHIP_TURN_ANGLE):e?o.rotateCounterclockwise(i.SHIP_TURN_ANGLE):o.rotateClockwise(i.SHIP_TURN_ANGLE))}(),o.increaseEnergy(i.SHIP_GENERATOR_ENERGY_STEP),o}),HasEnergy.call(o,GameCommonDefinitions.SHIP_MAX_ENERGY,GameCommonDefinitions.SHIP_MAX_ENERGY);let s=.3,c=vect(s,s,s).size();return o.onMouseDown=function(){switch(o.currentWeapon){case"laser":o.decreaseEnergy(i.LASER_FIRING_ENERGY_COST)&&o.createLaser(o);break;case"missile":o.decreaseEnergy(i.MISSILE_FIRING_ENERGY_COST)&&o.createMissile(o);break;case"mine":o.decreaseEnergy(i.MINE_FIRING_ENERGY_COST)&&o.createMine(o)}},o.onMouseDownHit=function(){o.currentWeapon="laser"},o.onMouseMove=function(e){a=o.calculateAngleToTurnToFacePosition(e)},o.onCollision=function(e){e.decreaseEnergy&&e.decreaseEnergy(o.energy,!0)},o.changeWeaponToMissile=function(e){o.currentWeapon="missile",o.alternateWeaponTimeLeft=e},o.changeWeaponToMine=function(e){o.currentWeapon="mine",o.alternateWeaponTimeLeft=e},o};