"use strict";import Assert from"../../libs/arslib/util/assert.js";import Util from"../../libs/arslib/util/util.js";import Vector,{vect}from"../../be/common/geometry/Vector.js";import screen from"../../be/client/singleton/Screen.js";import BECommonDefinitions from"../../be/common/BECommonDefinitions.js";import GameClientDefinitions from"./GameClientDefinitions.js";import BEClient from"../../be/client/singleton/BEClient.js";import Cookie from"../../libs/arslib/util/cookie.js";import resourceStore from"../../be/client/singleton/ResourceStore.js";import GameCommonDefinitions from"../common/GameCommonDefinitions.js";import particlesContainer from"../../be/client/singleton/ParticlesContainer.js";import InitialPage from"./InitialPage.js";import LeaderBoard from"./LeaderBoard.js";import StatusBar from"./StatusBar.js";function Z32(){let e,t;this.name="z32",this.userName,this.agentId;let n=()=>{this.userName="",this.agentId=null,e=null,t={}};function i(t,n=!1){Assert.assert(t&&t.position,"Elements has no position.");let i=e.getContext("2d");i.save(),i.fillStyle=n?"black":t.color;let o=n?4:2;i.fillRect(t.position.x-o/2,t.position.y-o/2,o,o),i.stroke(),i.restore()}n(),this.getMinimapData=(()=>t);let o=e=>i(e,!0),r=e=>i(e,!1);this.getMediaAssets=function(){return[GameCommonDefinitions.USER_SHIP_IMAGE,GameCommonDefinitions.AI_SHIP_IMAGE,GameCommonDefinitions.SPINNING_LASER_TRAP_IMAGE,GameCommonDefinitions.LOL_IMAGE,GameCommonDefinitions.TRUMP_IMAGE,GameCommonDefinitions.BONUS_ENERGY_IMAGE,GameCommonDefinitions.BONUS_MISSILE_IMAGE,GameCommonDefinitions.SHIP_SPLASH_ANIMATION_IMAGE_1,GameCommonDefinitions.SHIP_SPLASH_ANIMATION_IMAGE_2,GameCommonDefinitions.SHIP_SPLASH_ANIMATION_IMAGE_3,GameCommonDefinitions.SHIP_SPLASH_ANIMATION_IMAGE_4,GameCommonDefinitions.SHIP_SPLASH_ANIMATION_IMAGE_5]},this.getEffectsDescription=function(){return GameClientDefinitions.EFFECTS_DESCRIPTION};let a={energy:"DodgerBlue ",missile:"green",mine:"red"};this.addMinimapData=function(e){if(!e||!e[0])return;let n=e.map(e=>(e=e,Assert.assert(e,"No agent found"),[e.id,Math.trunc(e.rectangle.center.x),Math.trunc(e.rectangle.center.y),e.isBonus?a[e.type]:"white"]));var i;let s,m,l,c,I=vect(GameCommonDefinitions.MINIMAP_WIDTH,GameCommonDefinitions.MINIMAP_HEIGHT),f=vect(BECommonDefinitions.WORLD_WIDTH,BECommonDefinitions.WORLD_HEIGHT);for(;n.length;){[s,m,l,c]=n.pop();let e=vect(m,l),i=e.convert(f,I);i.y*=-1,i.x+=I.x/2,i.y+=I.y/2;let a={position:i,color:c},u={id:s,position:e,color:c};if(u.getPosition=(()=>u.position),t[s])return o(t[s]),r(a),void(t[s]=a);r(a),t[s]=a}},this.getSoundEffectDescription=function(e){return GameClientDefinitions[e]},this.removeMinimapData=function(e){e.forEach(e=>{t[e]&&(o(t[e]),delete t[e])})},this.getUserAgent=function(){return BEClient.getVisibleAgentByProperty("name",z32.userName)},this.userIsDead=function(){Cookie.setCookie("z32LastScore",this.getUserAgent().userScore),setTimeout(()=>{n(),BEClient.connectToGameServer("z32")},1e3)};let s=this;function m(e,t,n,i,o){if(!e.name)return;Assert.assertIsNumber(e.thrust),i.globalAlpha=.6,i.save();let r=screen.zoomOutFactor/2;e.name&&function(e,t,n,i,o){let r=14/i;e.font=`bold ${r}px Arial`,e.fillStyle="white",e.textAlign="center",e.translate(t.size.x/2,t.size.y/2),e.rotate(-n),e.fillText(o,0,t.size.y)}(i,o,n,r,e.name),e.energy&&function(e,t,n,i){let o=i*t.size.x/GameCommonDefinitions.SHIP_MAX_ENERGY;e.fillStyle="DodgerBlue",e.fillRect(-t.size.x/2,-t.size.y/1.5,o,GameClientDefinitions.ENERGY_BAR_HEIGHT/n)}(i,o,r,e.energy),function(e,t,n,i,o,r){if(t.id===n&&"laser"!==t.currentWeapon){let n=i.size.x*o/GameCommonDefinitions.ALTERNATE_WEAPON_MAX_TIME;e.fillStyle="mine"===t.currentWeapon?"red":"green",e.fillRect(-i.size.x/2,-i.size.y/1.5-(2*GameClientDefinitions.ENERGY_BAR_HEIGHT+1),n,GameClientDefinitions.AMMO_BAR_HEIGHT/r)}}(i,e,t,o,e.alternateWeaponTimeLeft,r),i.restore(),e.thrust&&function(e,t,n){if(!n)return;let i=4*n,o=15*i,r=e.getSize().x/2,a=Vector.makeFromAngleAndSize(t,r);a.invert().add(e.center);let s=Vector.makeFromAngleAndSize(t,i/3),m=(s.x+s.y)/5,l=20*i+1;particlesContainer.createParticleInSpray(a.x,a.y,-s.x,s.y,!0,250,0,0,o,i,1,m,n/1e3,l)}(o,n,e.thrust)}this.onAfterDrawScreen=function(t){!function(t){if(!e)return;let n=s.getUserAgent();n&&(s.removeMinimapData([n.id]),s.addMinimapData([n]));let i=screen.getSize().x-GameCommonDefinitions.MINIMAP_WIDTH,o=screen.getSize().y-GameCommonDefinitions.MINIMAP_HEIGHT;t.drawImage(e,i,o),t.strokeStyle="white",t.rect(i,o,GameCommonDefinitions.MINIMAP_WIDTH,GameCommonDefinitions.MINIMAP_HEIGHT)}(t),LeaderBoard.draw(t,BEClient.visibleAgents),StatusBar.draw(t,BEClient.visibleAgents)},this.onBeforeDrawAgent=function(e,t,n,i){},this.onAfterDrawAgent=function(e,t,n,i){e.imageName!==GameCommonDefinitions.BONUS_ENERGY_IMAGE?e.imageName!==GameCommonDefinitions.BONUS_MINE_IMAGE?e.imageName!==GameCommonDefinitions.BONUS_MISSILE_IMAGE?e.imageName!==GameCommonDefinitions.LASER_SPLASH_IMAGE&&e.imageName!==GameCommonDefinitions.MISSILE_SPLASH_IMAGE&&e.imageName!==GameCommonDefinitions.MINE_SPLASH_IMAGE?e.imageName!==GameCommonDefinitions.LASER_IMAGE&&e.imageName!==GameCommonDefinitions.MINE_IMAGE?e.imageName!==GameCommonDefinitions.MISSILE_IMAGE?m(e,this.agentId,t,n,i):function(e){particlesContainer.createParticle({positionX:e.rectangle.center.x,positionY:e.rectangle.center.y,speedX:0,speedY:0,screenParticle:!1,colorRed:50,colorGreen:235,colorBlue:50,timeToLive:particlesContainer.DEFAULT_PARTICLE_TIME_TO_LIVE,radius:2*particlesContainer.DEFAULT_RADIUS,occurrenceProbability:1})}(e):function(e){particlesContainer.createParticleInSpray(e.rectangle.center.x,e.rectangle.center.y,0,0,!1,60,50,225,particlesContainer.DEFAULT_PARTICLE_TIME_TO_LIVE/2,1.5*particlesContainer.DEFAULT_RADIUS,2,.1,2)}(e):function(e){particlesContainer.createSprayEmitter(e.rectangle.center.x,e.rectangle.center.y,0,0,!1,155,155,155)}(e):function(e){particlesContainer.createCircularEmitter(e.rectangle.center.x,e.rectangle.center.y,0,0,!1,e.id,0,255,0)}(e):function(e){particlesContainer.createParticleInSpray(e.rectangle.center.x,e.rectangle.center.y,0,0,!1,255,50,50,particlesContainer.DEFAULT_PARTICLE_TIME_TO_LIVE,2*particlesContainer.DEFAULT_RADIUS,.125,.2,particlesContainer.DEFAULT_PARTICLE_TIME_TO_LIVE/20,100)}(e):function(e){particlesContainer.createCircularEmitter(e.rectangle.center.x,e.rectangle.center.y,0,0,!1,e.id,0,0,255)}(e)},this.onConnectToServer=function(t,n){this.userName=t,this.agentId=n,function(){let t=(e=resourceStore.retrieveResourceObject(resourceStore.createNewImage(GameCommonDefinitions.MINIMAP_WIDTH,GameCommonDefinitions.MINIMAP_HEIGHT))).getContext("2d");t.save(),t.fillStyle="black",t.lineWidth=3,t.fillRect(0,0,GameCommonDefinitions.MINIMAP_WIDTH,GameCommonDefinitions.MINIMAP_HEIGHT),t.restore()}()},this.showInitialScreenAndReturnUserName=function(){function e(){BEClient.socket.emit("requestInitialPageInfo",{})}screen.hideCanvas();let t=BEClient.socket.on("requestInitialPageInfoReady",e=>{let t=document.getElementById("highScores");t&&(t.innerHTML="<b> High Scores </b> <br><br>",t.innerHTML+=e.highScores.join("<br>"))});e(),setInterval(()=>e(),6e4);const n=InitialPage();document.getElementById("contentArea").innerHTML=n;new Typed("#typed",{startDelay:1e3,backDelay:1e3,loop:!0,strings:["Avoid hitting the walls.","Blue bonuses are energies.","Press left mouse button to fire.","Blue rectangle above ship shows current energy.","Green bonuses enable guided missiles.","Green rectangle above ship shows time left for guided missiles.","Firing costs energy.","The ship follows the mouse.","Score increases by damaging and destroying enemies."],typeSpeed:120,backSpeed:120});let i=document.getElementById("userNameInput");return i.addEventListener("keyup",function(e){e.preventDefault(),13==e.keyCode&&playButton.click()}),new Promise(e=>{playButton.onclick=(()=>{window.clearInterval(t);let n=Util.removeTagsFromString(i.value);Cookie.setCookie("z32Name",n),screen.showCanvas(),document.getElementById("contentArea").innerHTML="",e(n||"Unnamed"+Math.round(1e4*Math.random()).toString())})})}}let z32=new Z32;export default z32;