"use strict";import Vector from"../../../common/geometry/Vector.js";import Rectangle from"../../../common/geometry/Rectangle.js";import AgentDefinitions from"../AgentDefinitions.js";import spaceSegments from"../../singleton/SpaceSegments.js";let agentId=1,agents={};function Environment(){let e;this.getAgents=function(){return agents},this.getCameras=function(){return agents.filter(e=>e.isCamera)},this.getAgentCamera=function(e){return this.getCameras().find(t=>t.owner===e)},this.addAgent=function(e){e.id=agentId,spaceSegments.addAgent(e),agents[agentId]=e,agentId++},this.getNearbyAgents=function(e){return spaceSegments.getNearbyAgents(e)},this.getNearbyUserAgents=function(e){return spaceSegments.getNearbyAgents(e).filter(e=>e.isUserAgent())},this.removeAgent=function(e){delete agents[e.id],spaceSegments.removeAgent(e)},this.checkAgentExists=function(e){return agents.hasOwnProperty(e.id)},this.killAllAgents=function(){for(let e in agents)agents[e].isSingleton||agents[0].die();spaceSegments.clear()},this.updateAgent=function(e){spaceSegments.updateAgent(e)},this.getNearbyAgentsByRectangle=function(e){return spaceSegments.getNearbyAgentsByRectangle(e)},this.otherAgentOverlappingWithProposedRectangle=function(e,t){let n=t||n,s=n.meanSize()/2,i=spaceSegments.getNearbyAgents(e);for(let t=0;t<i.length;t++){let g=i[t];if(e.id!==g.id&&(!g.isSingleton&&!g.isCamera&&n.center.distance(g.rectangle.center)<s+g.rectangle.meanSize()/2))return g}return null};let t,n=()=>{setTimeout(()=>{for(let e in agents)agents[e].behavior&&(agents[e].isCamera||agents[e].isUserAgent()||0!==this.getNearbyUserAgents(agents[e]).length)&&agents[e].behavior();n()},AgentDefinitions.AGENTS_EXECUTION_INTERVAL)};this.getUserAgents=function(){agents.filter(e=>e.isUserAgent())},this.setWorldRectangle=function(t){e=new Rectangle(new Vector,t)},this.getWorldRectangle=function(){return e},this.propagateUserEvent=function(e,n,s){(s?[s]:Object.values(agents)).forEach(s=>{if(s[e]||!+!s[e+"Hit"])if(t=n||t,"onKeyDown"!==e)if(["onMouseDown","onMouseUp","onMouseMove"].includes(e)&&s.isVisible&&t&&s.checkHit(t)){let t=e+"Hit";s[t]&&s[t](n)}else s[e]&&s[e](n);else s.onKeyDown&&s.onKeyDown(n)})},this.start=function(t,s){e=new Rectangle(new Vector,new Vector(t,s)),spaceSegments.start(t,s),n()}}let environment=new Environment;export default environment;