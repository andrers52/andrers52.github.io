"use strict";import Assert from"../../libs/arslib/util/assert.js";import{rect}from"../../common/geometry/Rectangle.js";import Vector,{vect}from"../../common/geometry/Vector.js";import TextToImage from"../TextToImage.js";import coordinatesConversion from"./CoordinatesConversion.js";import BEClientDefinitions from"../BEClientDefinitions.js";import particlesContainer from"./ParticlesContainer.js";import resourceStore from"./ResourceStore.js";function Screen(){let e,t,n,i,o,r,a,s,c,l,m,u;function g(){t.save(),t.fillStyle="black",t.fillRect(0,0,e.width,e.height),t.restore()}this.zoomOutFactor=1,this.hideCanvas=function(){e.style.visibility="hidden"},this.showCanvas=function(){e.style.visibility="visible"},this.getContext=function(){return t},this.setBackgroundImageName=function(e){n=!!e&&resourceStore.retrieveResourceObject(e)},this.start=function({onBeforeDrawAgentInput:n,onAfterDrawAgentInput:i,onAfterDrawScreenInput:g,minScreenDimensionInput:d,getVisibleAgentsInput:h,cameraInput:f,canvasIdInput:z,worldWidth:p,worldHeight:v}){u=h,c=n,l=i,m=g,s=d,a=f,r=z,o=rect(0,0,p,v),document.getElementById(r)||((e=document.createElement("canvas")).id=r,document.body.appendChild(e),e.focus()),this.adjustCanvasToWindowSize(),t=e.getContext("2d"),a.rectangle.size=this.setCameraSizeToCanvas(),particlesContainer.start()},this.setWorldToCameraSize=function(){o.size=a.rectangle.size.clone()},this.setCameraSizeToCanvas=function(){return a.rectangle.size=this.getSize().multiplyByScalar(this.zoomOutFactor),a.rectangle.size},this.getCanvas=function(){return e},window.addEventListener("onResizeCanvas",e=>{screen.adjustCanvasToWindowSize()}),this.adjustCanvasToWindowSize=function(){e.width=window.innerWidth,e.height=window.innerHeight,screen.zoomOutFactor=function(){let e,t=screen.getSize();if(Assert.assert(t.x,"screen not ready!"),t.x>=s&&t.y>=s)return e=1;let n=Math.min(t.x,t.y);return e=s/n}()},this.getCanvas=function(){return e},this.getSize=function(){return new Vector(e.width,e.height)},this.getRectangle=function(){return rect(0,0,e.width,e.height)},this.drawAgent=function(e){!e.imageName&&e.text&&function(e){let t=e.text;e.text!==t&&(e.rectangle.size=vect(5*t.length,15));let n=TextToImage.createImageFromText(e.rectangle,t,e.fontFace,e.backgroundColor,e.textColor);e.font=n.font,e.imageName=n.imageName}(e);let n=coordinatesConversion.rectangleWorldToCanvas(e.rectangle);e.imageName&&function(e,n){t.save(),e.opacity&&0!==e.opacity&&(t.globalAlpha=e.opacity),t.translate(n.center.x,n.center.y);let i=2*Math.PI-e.orientation;t.rotate(i),n.size.divideByScalar(screen.zoomOutFactor),t.translate(-n.size.x/2,-n.size.y/2),c&&c(e,i,t,n),t.globalCompositeOperation="lighter";try{t.drawImage(resourceStore.resources[e.imageName],0,0,n.size.x,n.size.y)}catch(e){console.log("Screen#drawAgentImage error: "+e)}l&&l(e,i,t,n),t.restore()}(e,n)},this.gamePresentationLoop=function(){g(),n&&function(){if(!a)return;let i=rect(0,0,n.width,n.height),r=o.topLeft().vectorDistance(a.rectangle.topLeft()).abs(),s=a.rectangle.convert(o.size,i.size),c=r.convert(o.size,i.size);t.drawImage(n,c.x,c.y,s.size.x,s.size.y,0,0,e.width,e.height)}(),function(){if(!a)return;let e=coordinatesConversion.rectangleWorldToCanvas(o);e.size.divideByScalar(screen.zoomOutFactor),t.save(),t.beginPath(),t.lineWidth=20,t.strokeStyle="red",t.rect(e.center.x-e.size.x/2,e.center.y-e.size.y/2,e.size.x+10,e.size.y+10),t.stroke(),t.restore()}(),function(e){let t=Object.values(e);if(a)for(let e=0;e<t.length;e++)screen.drawAgent(t[e],a)}(u()),m&&m(t),particlesContainer.animationStep(),i=window.setTimeout(screen.gamePresentationLoop,BEClientDefinitions.ANIMATION_INTERVAL)},this.stopGamePresentationLoop=function(){i&&(window.clearTimeout(i),g())}}let screen=new Screen;export default screen;