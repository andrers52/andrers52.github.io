"use strict";import EArray from"../../libs/arslib/enhancements/e-array.js";import Random from"../../libs/arslib/util/random.js";import Assert from"../../libs/arslib/util/assert.js";import{createCanvas}from"../../libs/arslib/util/image.js";import Effect from"../image/effect/Effect.js";function ResourceStore(){let e=["mp3"],t=["png","jpg","svg"];function r(e){let t=function(e){return EArray.last(e.split("."))}(e),r={mp3:"audio/mpeg3",png:"image/png",jpg:"image/jpeg",svg:"image/svg+xml",json:"application/json"};return Assert.assert(r.hasOwnProperty(t),`resourceStore#getMimeType suffix not found ${t}`),r[t]}this.resources={};let o=0;function s(){Assert.assert(o>0,"Error in resource loading counting in Resource Store..."),o--}function n(e,t){for(let r=0;r<t.length;r++)if(-1!==e.indexOf(t[r]))return!0;return!1}function i(t){return n(t,e)}function c(e){return n(e,t)}function a(e){return i(e)||c(e)||function(e){return n(e,[".json"])}(e)}function u(e){Assert.assert(e,"resourceStore#loadImage error: image not defined");try{let t=new XMLHttpRequest;t.onloadend=function(){!function(e,t){let r=new Image;r.onload=function(){resourceStore.resources[e]=r,s(),window.URL.revokeObjectURL(r.src)},r.src=window.URL.createObjectURL(t)}(e,t.response)},t.open("GET",e,!0),t.responseType="blob",t.send()}catch(t){throw"resourceStore#loadImage error trying to load image "+e+"\n Details: \n "+t}}function l(e){Assert.assert(e,"resourceStore#loadAudio error: image not defined"),function(e,t){let r=new Audio;function o(t){r.removeEventListener("canplaythrough",o,!1),r.removeEventListener("load",o,!1),resourceStore.resources[e]=r,s()}r.src="string"==typeof t?t:window.URL.createObjectURL(t),r.addEventListener("canplaythrough",o,!1),r.addEventListener("load",o,!1),r.addEventListener("error",function t(o){throw r.removeEventListener("error",t,!1),"Audio loading Error: "+e},!1),r.load()}(e,e)}function f(e){try{let t=new XMLHttpRequest;t.onloadend=(()=>{let r=t.responseText;"effects_descriptor.json"===EArray.last(e.split("/"))?this.createEffectsFromDescriptor(JSON.parse(r)):resourceStore.resources[e]=JSON.parse(r),s()}),t.open("GET",e,!0),t.responseType="text",t.send()}catch(t){throw"resourceStore#loadJSON error trying to read JSON file "+e+"\n Details: \n "+t}}this.isReady=function(){return o<=0},this.executeAfterLoad=null,this.createEffectsFromDescriptor=function(e){e.images.forEach(function(e){let t=e.newImageName,r=e.imageName,o=e.size,s=e.opacity,n=e.fillColor,i=e.strokeColor;for(const c of e.effectsToApply){let e=c.name,a=c.parameters,u=c.combineOption;Effect(r,o,s,n,i,t,e,a,u),!r&&t&&(r=t,t=null,o=null)}})},this.callWhenReady=function(e){0!==o?setTimeout(()=>{resourceStore.callWhenReady(e)},100):e()},this.clearAll=function(){this.resources={}},this.clearAllBut=function(e){Object.keys(this.resources).forEach(t=>{e.includes(t)||this.removeResource(t)})},this.addResource=function(e){if(this.resources[e])return;return o++,Assert.assert(a(e),"resourceStore: resource type not recognized"),(c(e)?u:i(e)?l:f)(e),this},this.addLocalResource=function(e,t){return this.resources[e]=t,this},this.createNewImageName=function(e=!1){let t;do{t=`${e?"":"temp_"}image_${Random.randomInt(1e8).toString()}.jpg`}while(this.resources[t]);return t},this.removeResourceIfTemporary=function(e){e.includes("temp_")&&this.removeResource(e)},this.removeTemporaryResources=function(){Object.keys(this.resources).forEach(e=>{e.includes("temp_")&&this.removeResource(e)})},this.createNewImage=function(e,t,r=!1){let o=this.createNewImageName(r);return this.addLocalResource(o,createCanvas(e,t)),o},this.cloneImage=function(e){let t=this.retrieveResourceObject(e),r=createCanvas(t.width,t.height);r.getContext("2d").drawImage(t,0,0);let o=this.createNewImageName(permanent);return this.addLocalResource(o,r),o},this.getImageData=function(e){let t=this.retrieveResourceObject(e);return t.getContext("2d").getImageData(0,0,t.width,t.height)},this.setImageData=function(e,t){this.retrieveResourceObject(e).getContext("2d").putImageData(t,0,0)},this.checkResourceObjectExists=function(e){return!(void 0===this.resources[e])},this.retrieveResourceObject=function(e){return this.checkResourceObjectExists(e)?this.resources[e]:(console.log("Resource Store error: trying to retrieve unknown resource: "+e),c(e)?createCanvas(10,10):new Audio)},this.removeResource=function(e){return delete this.resources[e],this},this.hasResource=function(e){return this.resources.hasOwnProperty(e)&&this.resources[e]},this.retrieveAllAudioNames=function(){let t=[];return e.map(e=>{t=t.concat(function(e){let t=r(e),o=[];return Object.keys(resourceStore.resources).forEach(e=>{r(e)===t&&o.push(e)}),o}(e))}),t}}let resourceStore=new ResourceStore;export default resourceStore;